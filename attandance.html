<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Điểm Danh Võ Sinh - Phật Quang Quyền</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .data-card {
            transition: transform 0.2s;
        }

        .data-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .student-photo-container {
            width: 64px;
            height: 64px;
            overflow: hidden;
            border-radius: 9999px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 2px solid #34D399;
        }

        .student-photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full transform transition-transform scale-95">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-2">Thông báo</h3>
            <p id="modal-message" class="text-gray-700 mb-4"></p>
            <div class="flex justify-end">
                <button id="modal-close-button"
                    class="bg-blue-600 text-white rounded-lg px-4 py-2 font-semibold hover:bg-blue-700 transition-colors">Đóng</button>
            </div>
        </div>
    </div>

    <div id="edit-group-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full transform transition-transform scale-95">
            <h3 class="text-xl font-bold text-gray-900 mb-2">Cập nhật nhóm</h3>
            <p class="text-gray-700 mb-4">Chọn nhóm mới cho võ sinh <span id="student-name-for-group-edit" class="font-bold"></span>.</p>
            <form id="edit-group-form">
                <input type="hidden" id="edit-student-id">
                <div class="mb-4">
                    <label for="new-group-select" class="block text-sm font-medium text-gray-700">Nhóm mới</label>
                    <select id="new-group-select" name="groupId" class="filter-select mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        <option value="">-- Chọn nhóm --</option>
                        </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-edit-group-button" class="bg-gray-200 text-gray-700 rounded-lg px-4 py-2 font-semibold hover:bg-gray-300 transition-colors">Hủy</button>
                    <button type="submit" id="save-group-button" class="bg-blue-600 text-white rounded-lg px-4 py-2 font-semibold hover:bg-blue-700 transition-colors">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-2xl p-6 md:p-10 my-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-blue-800 mb-2">
            Điểm Danh Võ Sinh
        </h1>
        <p class="text-center text-gray-600 mb-6">Môn phái Phật Quang Quyền</p>

        <hr class="border-t-2 border-gray-200 my-6">

        <div id="main-content">
            <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4 mb-6">
                <div class="flex-1">
                    <label for="filter-group" class="block text-sm font-medium text-gray-700">Lọc theo nhóm</label>
                    <select id="filter-group" class="filter-select mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="">Tất cả</option>
                        </select>
                </div>
                <div class="flex-1">
                    <label for="attendance-date" class="block text-sm font-medium text-gray-700">Ngày điểm danh</label>
                    <input type="date" id="attendance-date" class="filter-select mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="flex-1 flex items-end">
                    <button id="show-summary-button" class="px-6 py-2 rounded-md font-semibold text-white bg-green-600 hover:bg-green-700 transition-colors w-full">
                        Xem Kết Quả Tổng Quan
                    </button>
                </div>
            </div>

            <div id="attendance-list" class="space-y-4">
                <p class="text-gray-500 text-center" id="loading-message">Đang tải danh sách võ sinh...</p>
            </div>
        </div>

        <div id="summary-section" class="mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Kết Quả Điểm Danh</h2>
            <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                </div>
            <div id="absent-details-section" class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Danh Sách Võ Sinh Vắng</h3>
                <div id="absent-students-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>
            <div class="flex justify-end mt-4">
                <button id="back-to-attendance-button" class="px-6 py-2 rounded-md font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors">
                    Quay Lại Điểm Danh
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'api.php';
        const attendanceList = document.getElementById('attendance-list');
        const summarySection = document.getElementById('summary-section');
        const loadingMessage = document.getElementById('loading-message');
        const filterGroup = document.getElementById('filter-group');
        const attendanceDateInput = document.getElementById('attendance-date');
        const showSummaryButton = document.getElementById('show-summary-button');
        const backToAttendanceButton = document.getElementById('back-to-attendance-button');
        const mainContent = document.getElementById('main-content');
        const editGroupModal = document.getElementById('edit-group-modal');
        const editGroupForm = document.getElementById('edit-group-form');
        const newGroupSelect = document.getElementById('new-group-select');
        const cancelEditGroupButton = document.getElementById('cancel-edit-group-button');
        const studentNameForGroupEdit = document.getElementById('student-name-for-group-edit');
        const editStudentIdInput = document.getElementById('edit-student-id');

        // Modal elements
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
        }

        modalCloseButton.onclick = () => {
            messageModal.classList.add('hidden');
            messageModal.classList.remove('flex');
        };

        // Hàm cập nhật trạng thái điểm danh
        async function recordAttendance(studentId, status) {
            const date = attendanceDateInput.value;
            if (!date) {
                showMessage("Lỗi", "Vui lòng chọn ngày điểm danh.");
                return;
            }

            const data = new FormData();
            data.append('_action', 'record_attendance');
            data.append('student_id', studentId);
            data.append('status', status);
            data.append('attendance_date', date);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: data
                });
                const result = await response.json();
                if (!result.success) {
                    showMessage("Lỗi", `Điểm danh thất bại: ${result.message}`);
                }
            } catch (error) {
                showMessage("Lỗi", `Đã xảy ra lỗi khi điểm danh: ${error.message}`);
            }
        }

        // Hàm hiển thị danh sách võ sinh
        async function fetchAttendanceData() {
            loadingMessage.classList.remove('hidden');
            mainContent.classList.remove('hidden');
            summarySection.classList.add('hidden');

            const date = attendanceDateInput.value;
            const groupId = filterGroup.value;

            if (!date) {
                loadingMessage.textContent = "Vui lòng chọn ngày điểm danh.";
                return;
            }

            const url = `${API_URL}?_action=get_attendance_data&date=${date}&group_id=${groupId}`;

            try {
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    displayStudentsForAttendance(result.data.students);
                } else {
                    showMessage("Lỗi", `Không thể tải dữ liệu: ${result.message}`);
                    loadingMessage.textContent = "Không thể tải dữ liệu.";
                }
            } catch (error) {
                showMessage("Lỗi", `Đã xảy ra lỗi: ${error.message}`);
                loadingMessage.textContent = "Đã xảy ra lỗi khi tải dữ liệu.";
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        function displayStudentsForAttendance(students) {
            if (students.length === 0) {
                attendanceList.innerHTML = '<p class="text-center text-gray-500">Không tìm thấy võ sinh nào trong nhóm này.</p>';
                return;
            }

            let html = '';
            students.forEach(student => {
                const currentStatus = student.status || 'not_marked';
                html += `
                    <div class="data-card bg-white p-4 rounded-lg shadow-md flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="student-photo-container">
                                <img src="${student.photo_federation || 'https://placehold.co/64x64/e5e7eb/4b5563?text=N/A'}" alt="Ảnh võ sinh" onerror="this.onerror=null;this.src='https://placehold.co/64x64/e5e7eb/4b5563?text=N/A'">
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${student.name}</h3>
                                <p class="text-sm text-gray-600">Nhóm: ${student.group_name || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="attendance-btn present-btn px-4 py-2 rounded-md font-medium transition-colors ${currentStatus === 'present' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-green-500 hover:text-white'}" data-id="${student.id}" data-status="present">
                                Có mặt
                            </button>
                            <button class="attendance-btn absent-wp-btn px-4 py-2 rounded-md font-medium transition-colors ${currentStatus === 'absent_with_permission' ? 'bg-yellow-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-yellow-500 hover:text-white'}" data-id="${student.id}" data-status="absent_with_permission">
                                Vắng có phép
                            </button>
                            <button class="attendance-btn absent-wop-btn px-4 py-2 rounded-md font-medium transition-colors ${currentStatus === 'absent_without_permission' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-red-500 hover:text-white'}" data-id="${student.id}" data-status="absent_without_permission">
                                Vắng không phép
                            </button>
                            <button class="edit-group-button bg-blue-500 text-white rounded-md px-4 py-2 font-medium hover:bg-blue-600 transition-colors" data-id="${student.id}" data-name="${student.name}" data-group="${student.group_id || ''}">
                                Sửa nhóm
                            </button>
                        </div>
                    </div>
                `;
            });
            attendanceList.innerHTML = html;

            document.querySelectorAll('.attendance-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const studentId = e.target.dataset.id;
                    const status = e.target.dataset.status;

                    document.querySelectorAll(`.attendance-btn[data-id="${studentId}"]`).forEach(btn => {
                        btn.classList.remove('bg-green-600', 'text-white', 'bg-yellow-600', 'bg-red-600', 'hover:bg-green-500', 'hover:bg-yellow-500', 'hover:bg-red-500');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    if (status === 'present') e.target.classList.add('bg-green-600', 'text-white');
                    if (status === 'absent_with_permission') e.target.classList.add('bg-yellow-600', 'text-white');
                    if (status === 'absent_without_permission') e.target.classList.add('bg-red-600', 'text-white');

                    await recordAttendance(studentId, status);
                });
            });

            document.querySelectorAll('.edit-group-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const studentId = e.target.dataset.id;
                    const studentName = e.target.dataset.name;
                    const currentGroup = e.target.dataset.group;

                    editStudentIdInput.value = studentId;
                    studentNameForGroupEdit.textContent = studentName;
                    newGroupSelect.value = currentGroup;

                    editGroupModal.classList.remove('hidden');
                    editGroupModal.classList.add('flex');
                });
            });
        }

        // Hàm lấy và hiển thị kết quả tổng quan
        async function fetchAttendanceSummary() {
            loadingMessage.classList.remove('hidden');
            mainContent.classList.add('hidden');
            summarySection.classList.remove('hidden');

            const date = attendanceDateInput.value;
            const groupId = filterGroup.value;

            if (!date) {
                loadingMessage.textContent = "Vui lòng chọn ngày điểm danh.";
                return;
            }

            const url = `${API_URL}?_action=get_attendance_summary&date=${date}&group_id=${groupId}`;

            try {
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    displaySummary(result.data);
                } else {
                    showMessage("Lỗi", `Không thể tải dữ liệu tổng quan: ${result.message}`);
                    loadingMessage.textContent = "Không thể tải dữ liệu tổng quan.";
                }
            } catch (error) {
                showMessage("Lỗi", `Đã xảy ra lỗi khi tải dữ liệu: ${error.message}`);
                loadingMessage.textContent = "Đã xảy ra lỗi khi tải dữ liệu.";
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        function displaySummary(summaryData) {
            const summaryCards = document.getElementById('summary-cards');
            const absentStudentsList = document.getElementById('absent-students-list');

            const statusColors = {
                'present': 'bg-green-500',
                'absent_with_permission': 'bg-yellow-500',
                'absent_without_permission': 'bg-red-500'
            };

            const statusText = {
                'present': 'Có mặt',
                'absent_with_permission': 'Vắng có phép',
                'absent_without_permission': 'Vắng không phép'
            };

            summaryCards.innerHTML = `
                <div class="bg-blue-100 p-4 rounded-lg shadow-sm">
                    <h4 class="text-sm text-blue-800">Tổng số võ sinh</h4>
                    <p class="text-2xl font-bold text-blue-600">${summaryData.total_students}</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg shadow-sm">
                    <h4 class="text-sm text-green-800">Có mặt</h4>
                    <p class="text-2xl font-bold text-green-600">${summaryData.present_count}</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg shadow-sm">
                    <h4 class="text-sm text-yellow-800">Vắng có phép</h4>
                    <p class="text-2xl font-bold text-yellow-600">${summaryData.absent_with_permission_count}</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg shadow-sm">
                    <h4 class="text-sm text-red-800">Vắng không phép</h4>
                    <p class="text-2xl font-bold text-red-600">${summaryData.absent_without_permission_count}</p>
                </div>
            `;

            absentStudentsList.innerHTML = '';
            if (summaryData.absent_details.length > 0) {
                summaryData.absent_details.forEach(student => {
                    const studentCard = document.createElement('div');
                    studentCard.className = 'bg-white p-4 rounded-lg shadow-sm flex items-center space-x-4';
                    studentCard.innerHTML = `
                        <div class="student-photo-container flex-shrink-0">
                            <img src="${student.photo_federation || 'https://placehold.co/64x64/e5e7eb/4b5563?text=N/A'}" alt="Ảnh võ sinh" onerror="this.onerror=null;this.src='https://placehold.co/64x64/e5e7eb/4b5563?text=N/A'">
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-semibold text-gray-900">${student.name}</h4>
                            <span class="inline-block px-2 py-1 text-xs rounded-full mt-1 ${statusColors[student.status]} text-white">
                                ${statusText[student.status]}
                            </span>
                        </div>
                    `;
                    absentStudentsList.appendChild(studentCard);
                });
            } else {
                absentStudentsList.innerHTML = '<p class="text-center text-gray-500">Không có võ sinh nào vắng.</p>';
            }
        }

        // Lấy danh sách nhóm và thiết lập ngày mặc định
        async function fetchGroupsForFilterAndEdit() {
            try {
                const response = await fetch(`${API_URL}?_action=get_groups`);
                const result = await response.json();
                if (result.success) {
                    filterGroup.innerHTML = '<option value="">Tất cả</option>';
                    newGroupSelect.innerHTML = '<option value="">-- Chọn nhóm --</option>';

                    result.data.forEach(group => {
                        const optionFilter = document.createElement('option');
                        optionFilter.value = group.id;
                        optionFilter.textContent = group.name;
                        filterGroup.appendChild(optionFilter);

                        const optionEdit = document.createElement('option');
                        optionEdit.value = group.id;
                        optionEdit.textContent = group.name;
                        newGroupSelect.appendChild(optionEdit);
                    });
                } else {
                    // Nếu API lỗi, dùng các option cố định
                    console.error("Lỗi khi tải danh sách nhóm từ API. Sử dụng danh sách cố định.");
                    setupStaticGroups();
                }
            } catch (error) {
                console.error("Lỗi khi tải danh sách nhóm:", error);
                // Nếu có lỗi, dùng các option cố định
                setupStaticGroups();
            }
        }

        function setupStaticGroups() {
            const staticGroups = [
                { id: 1, name: 'Nhóm 1' },
                { id: 2, name: 'Nhóm 2' },
                { id: 3, name: 'Nhóm 3' },
                { id: 4, name: 'Nhóm 4' },
                { id: 5, name: 'Nhóm 5' },
                { id: 6, name: 'Nhóm 6' },
                { id: 7, name: 'Nhóm 7' },
                { id: 8, name: 'Nhóm 8' },
                { id: 9, name: 'Nhóm 9' },
                { id: 10, name: 'Nhóm 10' }
            ];
            
            filterGroup.innerHTML = '<option value="">Tất cả</option>';
            newGroupSelect.innerHTML = '<option value="">-- Chọn nhóm --</option>';
            
            staticGroups.forEach(group => {
                const optionFilter = document.createElement('option');
                optionFilter.value = group.id;
                optionFilter.textContent = group.name;
                filterGroup.appendChild(optionFilter);

                const optionEdit = document.createElement('option');
                optionEdit.value = group.id;
                optionEdit.textContent = group.name;
                newGroupSelect.appendChild(optionEdit);
            });
        }

        editGroupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = editStudentIdInput.value;
            const newGroupId = newGroupSelect.value;

            const data = new FormData();
            data.append('_action', 'update_student_group');
            data.append('id', studentId);
            data.append('group_id', newGroupId);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: data
                });
                const result = await response.json();
                if (result.success) {
                    showMessage("Thành công", "Đã cập nhật nhóm cho võ sinh.");
                    editGroupForm.reset();
                    editGroupModal.classList.add('hidden');
                    editGroupModal.classList.remove('flex');
                    fetchAttendanceData(); // Tải lại danh sách để thấy thay đổi
                } else {
                    showMessage("Lỗi", `Cập nhật nhóm thất bại: ${result.message}`);
                }
            } catch (error) {
                showMessage("Lỗi", `Đã xảy ra lỗi: ${error.message}`);
            }
        });

        cancelEditGroupButton.addEventListener('click', () => {
            editGroupForm.reset();
            editGroupModal.classList.add('hidden');
            editGroupModal.classList.remove('flex');
        });

        // Event Listeners
        filterGroup.addEventListener('change', fetchAttendanceData);
        attendanceDateInput.addEventListener('change', fetchAttendanceData);
        showSummaryButton.addEventListener('click', fetchAttendanceSummary);
        backToAttendanceButton.addEventListener('click', () => {
            mainContent.classList.remove('hidden');
            summarySection.classList.add('hidden');
        });

        // Khởi tạo trang
        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            attendanceDateInput.value = today;
            fetchGroupsForFilterAndEdit().then(() => {
                fetchAttendanceData();
            });
        };
    </script>
</body>

</html>
